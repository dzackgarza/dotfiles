# Feature: Tool Execution Foundation (v3.1)

## Overview

This phase focuses on building the core infrastructure for safe and efficient tool execution within the LLM REPL, enabling the system to interact with external tools and process their outputs.

## Sub-Features and User Tests

### 1. Tool Registry System

**Description:** A plugin-based system for discovering, registering, and managing various tools, including their capabilities and security configurations.

**User Stories:**
- As a developer, I can easily register a new tool with its capabilities and execution parameters.
- As a developer, I can define security sandboxing rules for each tool to prevent unauthorized access.
- As a user, the system should be aware of available tools and their functions.

**End-to-End User Tests:**
- **Test 1.1 (Tool Registration):**
    - **Action:** Register a mock `file_reader` tool with `read_file(path: str)` capability and a sandbox rule limiting access to `/tmp`.
    - **Expected Outcome:** The tool is successfully registered and its capabilities are discoverable by the system. Attempting to read a file outside `/tmp` using this tool should result in a security error.
- **Test 1.2 (Tool Discovery):**
    - **Action:** Query the system for available tools related to file operations.
    - **Expected Outcome:** The `file_reader` tool (and any other relevant file tools) is listed with its `read_file` capability.

### 2. Execution Engine

**Description:** The core component responsible for safely executing tool commands, capturing their output, handling errors, and managing execution timeouts.

**User Stories:**
- As a user, when the LLM decides to use a tool, it should execute reliably and return the correct output.
- As a user, if a tool execution fails or times out, I should receive clear error messages.

**End-to-End User Tests:**
- **Test 2.1 (Successful Tool Execution):**
    - **Action:** Instruct the LLM to use a `file_reader` tool to read a valid file within its allowed path (e.g., `/tmp/test.txt`).
    - **Expected Outcome:** The content of `/tmp/test.txt` is returned accurately. No errors are reported.
- **Test 2.2 (Tool Execution Failure - Invalid Path):**
    - **Action:** Instruct the LLM to use a `file_reader` tool to read a non-existent file (e.g., `/tmp/non_existent.txt`).
    - **Expected Outcome:** An appropriate error message indicating the file not found is returned. The system handles the error gracefully.
- **Test 2.3 (Tool Execution Timeout):**
    - **Action:** Instruct the LLM to execute a mock tool designed to run for longer than the configured timeout (e.g., a `sleep` command).
    - **Expected Outcome:** The tool execution is terminated after the timeout, and a timeout error message is returned.

### 3. Helper Block Parser

**Description:** A component that extracts `<helpers>...</helpers>` blocks from LLM responses, validates and sanitizes the contained code, and supports multiple languages.

**User Stories:**
- As a user, when the LLM generates code within `<helpers>` blocks, it should be correctly parsed and executed.
- As a user, if the LLM generates invalid or malicious code, the system should prevent its execution and report an error.

**End-to-End User Tests:**
- **Test 3.1 (Python Helper Block Parsing and Execution):**
    - **Action:** Provide an LLM response containing a `<helpers>` block with valid Python code (e.g., `print("Hello from helper!")`).
    - **Expected Outcome:** The Python code is executed, and "Hello from helper!" is printed to the console/output.
- **Test 3.2 (Bash Helper Block Parsing and Execution):**
    - **Action:** Provide an LLM response containing a `<helpers>` block with valid Bash code (e.g., `echo "Hello from bash!"`).
    - **Expected Outcome:** The Bash code is executed, and "Hello from bash!!" is printed to the console/output.
- **Test 3.3 (Invalid Code Handling):**
    - **Action:** Provide an LLM response containing a `<helpers>` block with syntactically incorrect Python code (e.g., `print("Missing quote)`).
    - **Expected Outcome:** The parser identifies the syntax error, prevents execution, and returns an error message indicating the issue.
- **Test 3.4 (Sanitization/Security Check):**
    - **Action:** Provide an LLM response containing a `<helpers>` block with potentially malicious code (e.g., `import os; os.system("rm -rf /")`).
    - **Expected Outcome:** The sanitization process detects the malicious intent, prevents execution, and reports a security violation.
