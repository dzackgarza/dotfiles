#!/bin/bash
# Test JACK audio session control via Cadence

set -e

echo "1. Stopping pulseaudio systemd service..."
systemctl --user stop pulseaudio.service pulseaudio.socket 2>/dev/null || true
sleep 1

echo "2. Stopping JACK..."
jack_control stop || echo "JACK was not running"
sleep 1

echo "3. Force restarting (stopping all audio processes)..."
killall -9 a2j a2jmidid artsd jackd jackdmp knotify4 lash ladishd ladiappd ladiconfd jmcore jackdbus pulseaudio 2>/dev/null || true
sleep 2

echo "4. Verifying stopped..."
if jack_control status > /dev/null 2>&1; then
    echo "ERROR: JACK still running"
    exit 1
fi
echo "✓ JACK stopped"
sleep 1

echo "5. Syncing yabridgectl..."
yabridgectl sync
sleep 1

echo "6. Starting JACK..."
jack_control start
sleep 2

echo "7. Verifying running..."
if jack_control status > /dev/null 2>&1; then
    echo "✓ JACK started successfully"
    jack_control status
else
    echo "ERROR: JACK failed to start"
    exit 1
fi

echo "8. Starting Reaper..."
reaper &
sleep 2

echo "Done"
