#!/bin/bash

if [ $# -eq 0 ]; then
  echo "Supply filename as argument"
  exit 1;
fi

print_usage() {
  printf "Usage: ..."
  printf "-f somefile.md -j"
}

files=''
view=false
totex=false
JUSTCOMPILE=false

while getopts 'vf:xj' flag; do
  case "${flag}" in
    v) view='true' ;;
    x) totex='true' ;;
    j) JUSTCOMPILE='true' ;;
    f) files="${OPTARG}" ;;
    *) print_usage
       exit 1 ;;
  esac
done

filepath=$(realpath "$files")
directory=$(dirname "$filepath")
filename=$(basename -- "$filepath")
extension="${filename##*.}"
filename="${filename%.*}"
first_run=true
status_ok=1

echo "File path: $filepath"
echo "Directory: $directory"
echo "File name: $filename"
echo "Extension: $extension"

if [ ! -f "$filepath" ]; then
  echo "Input file not found"
  exit 1;
fi


pandoc_compile() {
  echo "Output: $filepath -> $outfile"
  echo "Resource Path: $directory"
  cat "$filepath" | sed 's/\\\(\[\|\]\)/\n/g' | pandoc -f markdown --filter pandoc-include --filter pandoc-theorem-exe -r markdown+tex_math_dollars+simple_tables+table_captions+yaml_metadata_block+smart+blank_before_blockquote+backtick_code_blocks+link_attributes --template=/home/zack/Dropbox/Document\ Archive/Latex/pandoc_template.tex  --resource-path="$directory" --pdf-engine=pdflatex --lua-filter=/home/zack/Dropbox/Document\ Archive/Latex/dollar_math.lua -o "$outfile" #--pdf-engine-opt=-output-driver='xdvipdfmx -z0'
  status_ok=$?
}



echo "Starting..."
while true; do

  case $extension in
    "md")
      if [ "$totex" = true ]; then
        outfile="$directory/$filename.tex"
      else
        outfile="$directory/$filename.pdf"
      fi
      echo "Rendering markdown to $outfile"
      pandoc_compile 
      if [ "$JUSTCOMPILE" = true ]; then
        echo "Compile only, now exiting."
        exit 1
      else
        echo "Compiling and previewing.."
      fi
      ;;
    "asy")
      echo "Re-rendering..."
      outfile="$directory/$filename.eps"
      asy --render 0 "$filepath" -o "$outfile"
      ;;
    "tex")
      outfile="$directory/$filename.pdf"
      #pdflatex -interaction=nonstopmode "$filepath" --output-directory "$directory"
      #cat "$filepath" | sed 's/\\\(\[\|\]\)/\n/g' | pandoc -f markdown -r markdown+tex_math_dollars+simple_tables+table_captions+yaml_metadata_block+smart+blank_before_blockquote+backtick_code_blocks+link_attributes --template=/home/zack/Dropbox/Document\ Archive/Latex/pandoc_template.tex  --resource-path="$directory" --pdf-engine=pdflatex --lua-filter=/home/zack/Dropbox/Document\ Archive/Latex/dollar_math.lua -o "$outfile"
      #rm *.{aux,log,pre}
      pdflatex $filepath $outfile
      ;;
  esac

  if [ $status_ok -ne 0 ]; then
    echo "Error compiling"
    #notify-send "Doc Preview" "Error Compiling." --urgency=critical --expire-time=5000
  else
    if [ "$first_run" = true ]; then
      echo "First run"
      if [ "$view" = true ]; then
        okular "$outfile" &
      fi
      first_run=false;
    fi
  fi


  # Block execution until file write
  inotifywait -e CLOSE_WRITE -r "$directory";
done
